---
# tasks file for cloudwatch_agent
# Install/Manage amazon-cloudwatch-agent service.

- name: Install/Manage the most recent amazon-cloudwatch-agent version
  ansible.builtin.package:
    name: amazon-cloudwatch-agent
    state: latest
  tags: [ install_cloudwatch_agent ]

- name: Ensure amazon-cloudwatch-agent is enabled/running
  ansible.builtin.service:
    name: amazon-cloudwatch-agent
    state: started
    enabled: true
  tags: [ start_cloudwatch_agent ]

- name: Deploy CloudWatch Agent config file
  ansible.builtin.template:
    src: amazon-cloudwatch-agent.json.j2
    dest: /opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json
    owner: root
    group: root
    mode: '0644'
  notify: Restart CloudWatch Agent
  tags: [ restart_cloudwatch_agent ]
